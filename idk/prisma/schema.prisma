// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model with Security Features
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  emailVerified     DateTime?
  hashedPassword    String
  name              String
  dateOfBirth       DateTime
  age               Int
  location          String
  bio               String    @default("")
  
  // Age Verification
  ageVerified       Boolean   @default(false)
  ageVerifiedAt     DateTime?
  ageVerificationMethod String? // "id_upload", "credit_card", "third_party"
  
  // Account Status
  isActive          Boolean   @default(true)
  isBanned          Boolean   @default(false)
  bannedAt          DateTime?
  bannedReason      String?
  
  // Privacy & Safety
  isPrivate         Boolean   @default(false)
  showAge           Boolean   @default(true)
  showLocation      Boolean   @default(true)
  
  // GDPR Compliance
  dataProcessingConsent Boolean @default(false)
  marketingConsent      Boolean @default(false)
  termsAccepted         Boolean @default(false)
  termsAcceptedAt       DateTime?
  privacyPolicyAccepted Boolean @default(false)
  privacyPolicyAcceptedAt DateTime?
  
  // Security
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  lastLoginAt       DateTime?
  lastLoginIp       String?
  failedLoginAttempts Int     @default(0)
  lockedUntil       DateTime?
  
  // Profile
  photos            Photo[]
  interests         Interest[]
  
  // Interactions
  sentMatches       Match[]   @relation("SentMatches")
  receivedMatches   Match[]   @relation("ReceivedMatches")
  sentMessages      Message[] @relation("SentMessages")
  receivedMessages  Message[] @relation("ReceivedMessages")
  
  // Reports & Moderation
  reportsSubmitted  Report[]  @relation("ReportsSubmitted")
  reportsReceived   Report[]  @relation("ReportsReceived")
  moderationActions ModerationAction[]
  
  // Blocks
  blockedUsers      Block[]   @relation("BlockedUsers")
  blockedBy         Block[]   @relation("BlockedBy")
  
  // Data Export Requests (GDPR)
  dataExportRequests DataExportRequest[]
  dataDeletionRequests DataDeletionRequest[]
  
  // Audit Trail
  auditLogs         AuditLog[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete

  @@index([email])
  @@index([isActive, isBanned])
  @@index([createdAt])
}

// Photo Model with Content Moderation
model Photo {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  url             String
  thumbnailUrl    String?
  order           Int      @default(0)
  
  // Content Moderation
  isApproved      Boolean  @default(false)
  moderationStatus String  @default("pending") // "pending", "approved", "rejected"
  moderatedAt     DateTime?
  moderatedBy     String?
  rejectionReason String?
  
  // AI Moderation
  nsfwScore       Float?   // 0-1, higher = more NSFW
  violenceScore   Float?
  hateSpeechScore Float?
  
  // EXIF Data Removed
  exifRemoved     Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([moderationStatus])
}

model Interest {
  id        String   @id @default(uuid())
  name      String   @unique
  users     User[]
  createdAt DateTime @default(now())
}

// Match Model with Type (Snog, Marry, Avoid)
model Match {
  id          String   @id @default(uuid())
  senderId    String
  sender      User     @relation("SentMatches", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User     @relation("ReceivedMatches", fields: [receiverId], references: [id], onDelete: Cascade)
  type        String   // "snog", "marry", "avoid"
  isMatched   Boolean  @default(false) // True if both users liked each other
  createdAt   DateTime @default(now())
  
  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([isMatched])
}

// Message Model with Encryption
model Message {
  id          String   @id @default(uuid())
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  content     String   // Should be encrypted at application level
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  // Content Moderation
  isFlagged   Boolean  @default(false)
  flaggedReason String?
  
  createdAt   DateTime @default(now())
  deletedAt   DateTime? // Soft delete
  
  @@index([senderId, receiverId])
  @@index([createdAt])
}

// Report System for User Safety
model Report {
  id          String   @id @default(uuid())
  reporterId  String
  reporter    User     @relation("ReportsSubmitted", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedId  String
  reported    User     @relation("ReportsReceived", fields: [reportedId], references: [id], onDelete: Cascade)
  
  reason      String   // "harassment", "fake_profile", "inappropriate_content", "underage", "spam"
  description String?
  evidence    String?  // URLs to screenshots or other evidence
  
  status      String   @default("pending") // "pending", "investigating", "resolved", "dismissed"
  resolution  String?
  resolvedAt  DateTime?
  resolvedBy  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([reportedId, status])
  @@index([createdAt])
}

// Moderation Actions
model ModerationAction {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String   // "warning", "suspension", "ban", "content_removal"
  reason      String
  duration    Int?     // Duration in days for suspension
  performedBy String   // Moderator ID
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  
  @@index([userId])
}

// Block System
model Block {
  id          String   @id @default(uuid())
  blockerId   String
  blocker     User     @relation("BlockedUsers", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedId   String
  blocked     User     @relation("BlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

// GDPR Data Export Requests
model DataExportRequest {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status      String   @default("pending") // "pending", "processing", "completed", "failed"
  fileUrl     String?
  expiresAt   DateTime?
  
  createdAt   DateTime @default(now())
  completedAt DateTime?
  
  @@index([userId])
}

// GDPR Data Deletion Requests
model DataDeletionRequest {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status      String   @default("pending") // "pending", "processing", "completed"
  scheduledFor DateTime? // When deletion will occur (typically 30 days after request)
  
  createdAt   DateTime @default(now())
  completedAt DateTime?
  
  @@index([userId])
  @@index([status, scheduledFor])
}

// Audit Log for Security & Compliance
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action      String   // "login", "logout", "profile_update", "photo_upload", etc.
  ipAddress   String?
  userAgent   String?
  metadata    Json?    // Additional context
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Session Management
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([userId])
}

// Email Verification Tokens
model VerificationToken {
  id         String   @id @default(uuid())
  email      String
  token      String   @unique
  type       String   // "email_verification", "password_reset", "age_verification"
  expires    DateTime
  
  createdAt  DateTime @default(now())
  
  @@unique([email, token])
  @@index([token])
}

// Rate Limiting (for API abuse prevention)
model RateLimit {
  id          String   @id @default(uuid())
  identifier  String   // IP address or user ID
  endpoint    String
  requests    Int      @default(0)
  windowStart DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([identifier, endpoint, windowStart])
  @@index([identifier, windowStart])
}
